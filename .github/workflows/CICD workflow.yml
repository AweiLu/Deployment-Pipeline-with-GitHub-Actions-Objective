name: CI/CD Deployment Pipeline

# è§¸ç™¼æ¢ä»¶ï¼šåªå…è¨±æ‰‹å‹•è§¸ç™¼ï¼ˆç¬¦åˆ Grade E è¦æ±‚ï¼‰
on:
  workflow_dispatch:

# è¨­å®šæ¬Šé™
permissions:
  contents: write     # å»ºç«‹/æ›´æ–° Release éœ€è¦
  actions: read       # è®€å– artifacts éœ€è¦

jobs:
  # Build Job - èˆ‡åŸºç¤ä»»å‹™ç›¸åŒ
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Build Application
        run: |
          set -e
          echo "=== é–‹å§‹æ§‹å»ºæ‡‰ç”¨ç¨‹å¼ ==="
          
          if [ -f package.json ]; then
            echo "ğŸ“¦ æ§‹å»º Node.js å°ˆæ¡ˆ"
            npm ci || npm install
            npm run build || echo "âš ï¸ æ²’æœ‰ build scriptï¼Œä½¿ç”¨åŸå§‹æª”æ¡ˆ"
            
          elif [ -f setup.py ] || [ -f pyproject.toml ]; then
            echo "ğŸ æ§‹å»º Python å°ˆæ¡ˆ"
            python -m pip install --upgrade pip
            
            if [ -f requirements.txt ]; then
              pip install -r requirements.txt
            fi
            
            # å¦‚æœæœ‰ setup.pyï¼Œå˜—è©¦æ§‹å»º
            if [ -f setup.py ]; then
              python setup.py build || echo "âš ï¸ Build å¤±æ•—ï¼Œä½¿ç”¨åŸå§‹æª”æ¡ˆ"
            fi
            
          else
            echo "â„¹ï¸ é€šç”¨å°ˆæ¡ˆï¼Œæº–å‚™æ‰“åŒ…åŸå§‹æª”æ¡ˆ"
          fi
          
          # å‰µå»ºæ§‹å»ºè³‡è¨Š
          echo "BUILD_TIME=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> build-info.txt
          echo "BUILD_SHA=${GITHUB_SHA}" >> build-info.txt
          echo "BUILD_REF=${GITHUB_REF}" >> build-info.txt

      - name: Create Build Package
        run: |
          echo "ğŸ“¦ å‰µå»ºç™¼å¸ƒåŒ…..."
          # æ’é™¤ä¸éœ€è¦çš„æª”æ¡ˆå’Œç›®éŒ„
          zip -r build-package.zip . \
            -x ".git/*" \
            -x ".github/*" \
            -x "node_modules/*" \
            -x "__pycache__/*" \
            -x "*.pyc" \
            -x "venv/*" \
            -x ".venv/*" \
            -x "*.log" \
            -x ".DS_Store"
          
          # é¡¯ç¤ºåŒ…çš„å¤§å°
          ls -lh build-package.zip

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-artifact
          path: build-package.zip
          retention-days: 30

  # Deploy Dev - éƒ¨ç½²åˆ°é–‹ç™¼ç’°å¢ƒ
  deploy-dev:
    needs: build
    runs-on: ubuntu-latest
    environment: development
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: build-artifact

      - name: Deploy to Development Environment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          
          # ä½¿ç”¨ dev-vX.Y æ ¼å¼çš„æ¨™ç±¤
          TAG="dev-v1.0"
          NOTE="Development build for testing"
          
          echo "ğŸš€ éƒ¨ç½²åˆ° Development ç’°å¢ƒ..."
          echo "æ¨™ç±¤: ${TAG}"
          echo "èªªæ˜: ${NOTE}"
          
          # å¦‚æœ release å·²å­˜åœ¨ï¼Œå…ˆåˆªé™¤ä»¥é¿å…è¡çª
          if gh release view "${TAG}" >/dev/null 2>&1; then
            echo "ğŸ“ åˆªé™¤ç¾æœ‰çš„ dev ç‰ˆæœ¬ ${TAG}"
            gh release delete "${TAG}" --yes
          fi
          
          # å‰µå»º dev release
          gh release create "${TAG}" build-package.zip \
            --title "Development Release - ${TAG}" \
            --notes "${NOTE}" \
            --prerelease
          
          echo "âœ… æˆåŠŸéƒ¨ç½²åˆ° Development ç’°å¢ƒï¼"

  # Deploy Staging - éƒ¨ç½²åˆ° staging ç’°å¢ƒ
  deploy-staging:
    needs: deploy-dev
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: build-artifact

      - name: Deploy to Staging Environment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          
          # ä½¿ç”¨ staging-vX.Y æ ¼å¼çš„æ¨™ç±¤
          TAG="staging-v1.0"
          NOTE="Testing pre-production release"
          
          echo "ğŸ”„ éƒ¨ç½²åˆ° Staging ç’°å¢ƒ..."
          echo "æ¨™ç±¤: ${TAG}"
          echo "èªªæ˜: ${NOTE}"
          
          # å¦‚æœ release å·²å­˜åœ¨ï¼Œå…ˆåˆªé™¤ä»¥é¿å…è¡çª
          if gh release view "${TAG}" >/dev/null 2>&1; then
            echo "ğŸ“ åˆªé™¤ç¾æœ‰çš„ staging ç‰ˆæœ¬ ${TAG}"
            gh release delete "${TAG}" --yes
          fi
          
          # å‰µå»º staging release
          gh release create "${TAG}" build-package.zip \
            --title "Staging Release - ${TAG}" \
            --notes "${NOTE}" \
            --prerelease
          
          echo "âœ… æˆåŠŸéƒ¨ç½²åˆ° Staging ç’°å¢ƒï¼"

  # Deploy Production - éƒ¨ç½²åˆ° production ç’°å¢ƒï¼ˆéœ€è¦æ‰‹å‹•å¯©æ ¸ï¼‰
  deploy-production:
    needs: deploy-staging
    runs-on: ubuntu-latest
    environment: production  # ä½¿ç”¨ production ç’°å¢ƒï¼ˆéœ€è¦è¨­å®šä¿è­·è¦å‰‡å’Œå¯©æ ¸è€…ï¼‰
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: build-artifact

      - name: Deploy to Production Environment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          
          # ä½¿ç”¨ prod-vX.Y æ ¼å¼çš„æ¨™ç±¤
          TAG="prod-v1.0"
          NOTE="Production release - stable version"
          
          echo "ğŸš€ éƒ¨ç½²åˆ° Production ç’°å¢ƒ..."
          echo "æ¨™ç±¤: ${TAG}"
          echo "èªªæ˜: ${NOTE}"
          
          # å¦‚æœ release å·²å­˜åœ¨ï¼Œå…ˆåˆªé™¤ä»¥é¿å…è¡çª
          if gh release view "${TAG}" >/dev/null 2>&1; then
            echo "ğŸ“ åˆªé™¤ç¾æœ‰çš„ production ç‰ˆæœ¬ ${TAG}"
            gh release delete "${TAG}" --yes
          fi
          
          # å‰µå»º production releaseï¼ˆæ­£å¼ç‰ˆæœ¬ï¼Œä¸æ˜¯ pre-releaseï¼‰
          gh release create "${TAG}" build-package.zip \
            --title "Production Release - ${TAG}" \
            --notes "${NOTE}"
          
          echo "ğŸ‰ æˆåŠŸéƒ¨ç½²åˆ° Production ç’°å¢ƒï¼"