name: CI/CD Deployment Pipeline

# è§¸ç™¼æ¢ä»¶ï¼šæ¨é€åˆ° main åˆ†æ”¯è‡ªå‹•åŸ·è¡Œï¼Œä¹Ÿå¯æ‰‹å‹•è§¸ç™¼
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # æ‰‹å‹•è§¸ç™¼

# è¨­å®šæ¬Šé™
permissions:
  contents: write     # å»ºç«‹/æ›´æ–° Release éœ€è¦
  actions: read       # è®€å– artifacts éœ€è¦
  checks: write       # å¯«å…¥æ¸¬è©¦çµæœéœ€è¦

jobs:
  # ç¬¬ä¸€éšæ®µï¼šæ¸¬è©¦ã€æ§‹å»ºå’Œæ‰“åŒ…ï¼ˆåˆä½µç‚ºä¸€å€‹ jobï¼‰
  build-lint-test-package:
    name: Build, Lint, Test, Package
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Dependencies & Run Tests
        run: |
          set -e
          echo "=== æª¢æ¸¬å°ˆæ¡ˆé¡å‹ä¸¦åŸ·è¡Œæ¸¬è©¦ ==="
          
          if [ -f package.json ]; then
            echo "ğŸ“¦ æª¢æ¸¬åˆ° Node.js å°ˆæ¡ˆ"
            npm ci || npm install
            
            # åŸ·è¡Œ linting å’Œæ¸¬è©¦
            npm run lint || echo "âš ï¸ æ²’æœ‰ lint scriptï¼Œè·³é"
            npm run test || echo "âš ï¸ æ²’æœ‰ test scriptï¼Œè·³é"
            
          elif [ -f setup.py ] || [ -f pyproject.toml ] || [ -f requirements.txt ]; then
            echo "ğŸ æª¢æ¸¬åˆ° Python å°ˆæ¡ˆ"
            python -m pip install --upgrade pip
            
            if [ -f requirements.txt ]; then
              pip install -r requirements.txt
            fi
            
            # åŸ·è¡Œ Python æ¸¬è©¦
            if [ -f requirements-dev.txt ]; then
              pip install -r requirements-dev.txt
            fi
            
            # å˜—è©¦åŸ·è¡Œå¸¸è¦‹çš„æ¸¬è©¦å‘½ä»¤
            python -m pytest || python -m unittest discover || echo "âš ï¸ æ²’æœ‰æ‰¾åˆ°æ¸¬è©¦ï¼Œè·³é"
            
          else
            echo "â„¹ï¸ æ²’æœ‰æª¢æ¸¬åˆ°ç‰¹å®šå°ˆæ¡ˆé¡å‹ï¼Œè·³éæ¸¬è©¦éšæ®µ"
          fi

      - name: Build Application
        run: |
          set -e
          echo "=== é–‹å§‹æ§‹å»ºæ‡‰ç”¨ç¨‹å¼ ==="
          
          if [ -f package.json ]; then
            echo "ğŸ“¦ æ§‹å»º Node.js å°ˆæ¡ˆ"
            npm ci || npm install
            npm run build || echo "âš ï¸ æ²’æœ‰ build scriptï¼Œä½¿ç”¨åŸå§‹æª”æ¡ˆ"
            
          elif [ -f setup.py ] || [ -f pyproject.toml ]; then
            echo "ğŸ æ§‹å»º Python å°ˆæ¡ˆ"
            python -m pip install --upgrade pip
            
            if [ -f requirements.txt ]; then
              pip install -r requirements.txt
            fi
            
            # å¦‚æœæœ‰ setup.pyï¼Œå˜—è©¦æ§‹å»º
            if [ -f setup.py ]; then
              python setup.py build || echo "âš ï¸ Build å¤±æ•—ï¼Œä½¿ç”¨åŸå§‹æª”æ¡ˆ"
            fi
            
          else
            echo "â„¹ï¸ é€šç”¨å°ˆæ¡ˆï¼Œæº–å‚™æ‰“åŒ…åŸå§‹æª”æ¡ˆ"
          fi
          
          # å‰µå»ºæ§‹å»ºè³‡è¨Š
          echo "BUILD_TIME=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> build-info.txt
          echo "BUILD_SHA=${GITHUB_SHA}" >> build-info.txt
          echo "BUILD_REF=${GITHUB_REF}" >> build-info.txt

      - name: Create Build Package
        run: |
          echo "ğŸ“¦ å‰µå»ºç™¼å¸ƒåŒ…..."
          # æ’é™¤ä¸éœ€è¦çš„æª”æ¡ˆå’Œç›®éŒ„
          zip -r build-package.zip . \
            -x ".git/*" \
            -x ".github/*" \
            -x "node_modules/*" \
            -x "__pycache__/*" \
            -x "*.pyc" \
            -x "venv/*" \
            -x ".venv/*" \
            -x "*.log" \
            -x ".DS_Store"
          
          # é¡¯ç¤ºåŒ…çš„å¤§å°
          ls -lh build-package.zip

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: build-package
          path: build-package.zip
          retention-days: 30

  # ç¬¬äºŒéšæ®µï¼šéƒ¨ç½²åˆ°é–‹ç™¼ç’°å¢ƒ (Pre-release)
  deploy-to-dev:
    name: Deploy to Dev (Pre-release)
    needs: build-lint-test-package
    runs-on: ubuntu-latest
    environment: development
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Build Package
        uses: actions/download-artifact@v4
        with:
          name: build-package

      - name: Deploy to Development
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ vars.DEV_TAG || 'dev-latest' }}
          NOTE: ${{ vars.DEV_RELEASE_NOTE || 'Development release - automated deployment' }}
        run: |
          set -e
          echo "ğŸš€ éƒ¨ç½²åˆ°é–‹ç™¼ç’°å¢ƒ..."
          
          # å¦‚æœ release å·²å­˜åœ¨ï¼Œå…ˆåˆªé™¤
          if gh release view "${TAG}" >/dev/null 2>&1; then
            echo "ğŸ“ åˆªé™¤ç¾æœ‰çš„é–‹ç™¼ç‰ˆæœ¬ ${TAG}"
            gh release delete "${TAG}" --yes
          fi
          
          # å‰µå»ºæ–°çš„é–‹ç™¼ç‰ˆæœ¬ (Pre-release)
          gh release create "${TAG}" build-package.zip \
            --title "Development Release - ${TAG}" \
            --notes "${NOTE}" \
            --prerelease
          
          echo "âœ… æˆåŠŸéƒ¨ç½²åˆ°é–‹ç™¼ç’°å¢ƒï¼"

  # ç¬¬ä¸‰éšæ®µï¼šéƒ¨ç½²åˆ°æ¸¬è©¦ç’°å¢ƒ (Pre-release)
  deploy-to-staging:
    name: Deploy to Staging (Pre-release)
    needs: deploy-to-dev
    runs-on: ubuntu-latest
    environment: staging
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Build Package
        uses: actions/download-artifact@v4
        with:
          name: build-package

      - name: Deploy to Staging
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ vars.STAGING_TAG || 'staging-latest' }}
          NOTE: ${{ vars.STAGING_RELEASE_NOTE || 'Staging release - ready for QA testing' }}
        run: |
          set -e
          echo "ğŸ”„ éƒ¨ç½²åˆ°æ¸¬è©¦ç’°å¢ƒ..."
          
          if gh release view "${TAG}" >/dev/null 2>&1; then
            echo "ğŸ“ åˆªé™¤ç¾æœ‰çš„æ¸¬è©¦ç‰ˆæœ¬ ${TAG}"
            gh release delete "${TAG}" --yes
          fi
          
          # å‰µå»ºæ–°çš„æ¸¬è©¦ç‰ˆæœ¬ (Pre-release)
          gh release create "${TAG}" build-package.zip \
            --title "Staging Release - ${TAG}" \
            --notes "${NOTE}" \
            --prerelease
          
          echo "âœ… æˆåŠŸéƒ¨ç½²åˆ°æ¸¬è©¦ç’°å¢ƒï¼"

  # ç¬¬å››éšæ®µï¼šéƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ (Final release)
  deploy-to-production:
    name: Deploy to Production (Final release)
    needs: deploy-to-staging
    runs-on: ubuntu-latest
    environment: production  # éœ€è¦äººå·¥å¯©æ ¸
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Build Package
        uses: actions/download-artifact@v4
        with:
          name: build-package

      - name: Deploy to Production
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ vars.PROD_TAG || 'prod-latest' }}
          NOTE: ${{ vars.PROD_RELEASE_NOTE || 'Production release - stable version' }}
        run: |
          set -e
          echo "ğŸš€ éƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ..."
          
          if gh release view "${TAG}" >/dev/null 2>&1; then
            echo "ğŸ“ åˆªé™¤ç¾æœ‰çš„ç”Ÿç”¢ç‰ˆæœ¬ ${TAG}"
            gh release delete "${TAG}" --yes
          fi
          
          # å‰µå»ºæ–°çš„ç”Ÿç”¢ç‰ˆæœ¬ (Final release - ä¸æ˜¯ pre-release)
          gh release create "${TAG}" build-package.zip \
            --title "Production Release - ${TAG}" \
            --notes "${NOTE}"
          
          echo "ğŸ‰ æˆåŠŸéƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒï¼"