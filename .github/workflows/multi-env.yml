name: Multi-Stage Pipeline

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write
  actions: read
  checks: read

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install & Build
        run: |
          # æª¢æŸ¥æ˜¯å¦ç‚º Node.js å°ˆæ¡ˆ
          if [ -f "package.json" ]; then
            echo "æª¢æ¸¬åˆ° Node.js å°ˆæ¡ˆï¼Œå®‰è£ä¾è³´..."
            npm install
            npm run build || echo "æ²’æœ‰ build è…³æœ¬ï¼Œç¹¼çºŒåŸ·è¡Œ"
          # æª¢æŸ¥æ˜¯å¦ç‚º Python å°ˆæ¡ˆ
          elif [ -f "requirements.txt" ] || [ -f "setup.py" ]; then
            echo "æª¢æ¸¬åˆ° Python å°ˆæ¡ˆï¼Œå®‰è£ä¾è³´..."
            python -m pip install --upgrade pip
            if [ -f "requirements.txt" ]; then
              pip install -r requirements.txt
            fi
            if [ -f "setup.py" ]; then
              pip install -e .
            fi
          else
            echo "ç„¡æ³•æª¢æ¸¬å°ˆæ¡ˆé¡å‹ï¼Œå‰µå»ºæ¨¡æ“¬æ§‹å»ºç”¢ç‰©..."
            mkdir -p dist
            cp -r * dist/ 2>/dev/null || :
            echo "æ¨¡æ“¬æ§‹å»ºç”¢ç‰©å·²å‰µå»º"
          fi
          
      - name: Create build info
        run: |
          # ç¢ºä¿ dist ç›®éŒ„å­˜åœ¨
          mkdir -p dist
          echo "BUILD_TIME=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" > dist/build-info.txt
          echo "BUILD_SHA=${GITHUB_SHA}" >> dist/build-info.txt
          echo "BUILD_REF=${GITHUB_REF}" >> dist/build-info.txt
          
      - uses: actions/upload-artifact@v4
        with:
          name: build-artifact
          path: dist/

  test-unit:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: build-artifact
          path: dist
      - name: Run Unit Tests
        run: |
          echo "ğŸ§ª åŸ·è¡Œå–®å…ƒæ¸¬è©¦..."
          
          # æª¢æŸ¥æ˜¯å¦ç‚º Node.js å°ˆæ¡ˆ
          if [ -f "package.json" ]; then
            echo "æª¢æ¸¬åˆ° Node.js å°ˆæ¡ˆ"
            npm install
            if grep -q "\"test:unit\"" package.json; then
              npm run test:unit || echo "âŒ æ¸¬è©¦å¤±æ•—ï¼Œä½†ç¹¼çºŒæµç¨‹ç”¨æ–¼æ¼”ç¤º"
            else
              echo "ğŸ“ åŸ·è¡Œæ¨¡æ“¬å–®å…ƒæ¸¬è©¦"
              echo "å–®å…ƒæ¸¬è©¦: âœ… æ¨¡æ“¬é€šé"
            fi
          # æª¢æŸ¥æ˜¯å¦ç‚º Python å°ˆæ¡ˆ
          elif [ -f "pytest.ini" ] || [ -d "tests" ]; then
            echo "æª¢æ¸¬åˆ° Python æ¸¬è©¦æ¡†æ¶"
            python -m pip install --upgrade pip
            pip install pytest
            python -m pytest || echo "âŒ æ¸¬è©¦å¤±æ•—ï¼Œä½†ç¹¼çºŒæµç¨‹ç”¨æ–¼æ¼”ç¤º"
          else
            echo "ğŸ“ åŸ·è¡Œæ¨¡æ“¬å–®å…ƒæ¸¬è©¦"
            echo "å–®å…ƒæ¸¬è©¦: âœ… æ¨¡æ“¬é€šé"
          fi

  test-integration:
    runs-on: ubuntu-latest
    needs: test-unit
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          name: build-artifact
          path: dist
      - name: Run Integration Tests
        run: |
          echo "ğŸ§ª åŸ·è¡Œæ•´åˆæ¸¬è©¦..."
          
          # æª¢æŸ¥æ˜¯å¦ç‚º Node.js å°ˆæ¡ˆ
          if [ -f "package.json" ]; then
            echo "æª¢æ¸¬åˆ° Node.js å°ˆæ¡ˆ"
            npm install
            if grep -q "\"test:integration\"" package.json; then
              npm run test:integration || echo "âŒ æ¸¬è©¦å¤±æ•—ï¼Œä½†ç¹¼çºŒæµç¨‹ç”¨æ–¼æ¼”ç¤º"
            else
              echo "ğŸ“ åŸ·è¡Œæ¨¡æ“¬æ•´åˆæ¸¬è©¦"
              echo "API æ•´åˆæ¸¬è©¦: âœ… æ¨¡æ“¬é€šé"
              echo "è³‡æ–™åº«æ•´åˆæ¸¬è©¦: âœ… æ¨¡æ“¬é€šé"
            fi
          else
            echo "ğŸ“ åŸ·è¡Œæ¨¡æ“¬æ•´åˆæ¸¬è©¦"
            echo "API æ•´åˆæ¸¬è©¦: âœ… æ¨¡æ“¬é€šé"
            echo "è³‡æ–™åº«æ•´åˆæ¸¬è©¦: âœ… æ¨¡æ“¬é€šé"
          fi

  deploy-staging:
    runs-on: ubuntu-latest
    needs: test-integration
    environment: staging
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/download-artifact@v4
        with:
          name: build-artifact
          path: dist
      
      - name: Release to Staging
        env:
          TEST_ENV: ${{ vars.TEST_ENV || 'staging' }}
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "éƒ¨ç½²åˆ° ${TEST_ENV} ç’°å¢ƒ"
          
          # æ‰“åŒ…æ§‹å»ºç”¢ç‰©ç‚ºå£“ç¸®æª”
          cd dist
          zip -r ../staging-release.zip .
          cd ..
          
          # å‰µå»ºç™¼å¸ƒ
          gh release create "staging-${{ github.run_id }}" staging-release.zip \
            --title "Staging Release ${{ github.run_id }}" \
            --notes "æ¸¬è©¦ç’°å¢ƒç™¼å¸ƒ - $(date)" \
            --prerelease
          
          echo "âœ… æˆåŠŸéƒ¨ç½²åˆ°æ¸¬è©¦ç’°å¢ƒ"

  deploy-production:
    runs-on: ubuntu-latest
    needs: deploy-staging
    environment: production   # å¿…é ˆåœ¨ GitHub è¨­å®š Required reviewers
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/download-artifact@v4
        with:
          name: build-artifact
          path: dist
      
      - name: Release to Production
        env:
          TEST_ENV: ${{ vars.TEST_ENV || 'production' }}
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "éƒ¨ç½²åˆ° ${TEST_ENV} ç’°å¢ƒ"
          
          # æ‰“åŒ…æ§‹å»ºç”¢ç‰©ç‚ºå£“ç¸®æª”
          cd dist
          zip -r ../production-release.zip .
          cd ..
          
          # å‰µå»ºç™¼å¸ƒ
          gh release create "prod-${{ github.run_id }}" production-release.zip \
            --title "Production Release ${{ github.run_id }}" \
            --notes "ç”Ÿç”¢ç’°å¢ƒç™¼å¸ƒ - ç¶“éå¯©æ‰¹ - $(date)"
          
          echo "âœ… æˆåŠŸéƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ"