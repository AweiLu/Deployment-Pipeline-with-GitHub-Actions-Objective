name: Multi-Stage Pipeline

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write
  actions: read
  checks: read

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install & Build
        run: |
          npm ci || npm install
          npm run build
      - uses: actions/upload-artifact@v4
        with:
          name: build-artifact
          path: dist/

  test-unit:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: build-artifact
      - name: Run Unit Tests
        run: npm run test:unit

  test-integration:
    runs-on: ubuntu-latest
    needs: test-unit
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: build-artifact
      - name: Run Integration Tests
        run: npm run test:integration

  deploy-staging:
    runs-on: ubuntu-latest
    needs: test-integration
    environment: staging
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: build-artifact
      - name: Release to Staging
        env:
          TEST_ENV: ${{ vars.TEST_ENV }}
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Deploying to ${TEST_ENV} environment"
          gh release create "staging-${{ github.run_id }}" dist/* --notes "Staging release after tests"

  deploy-production:
    runs-on: ubuntu-latest
    needs: deploy-staging
    environment: production   # 必須在 GitHub 設定 Required reviewers
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: build-artifact
      - name: Release to Production
        env:
          TEST_ENV: ${{ vars.TEST_ENV }}
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Deploying to ${TEST_ENV} environment"
          gh release create "prod-${{ github.run_id }}" dist/* --notes "Production release after approval"